<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS ENGINE - MULTIPLAYER FIXED</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        /* ESTILO GERAL */
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; color: white; user-select: none; touch-action: none; }
        canvas { display: block; }
        
        /* UTILIT√ÅRIOS */
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #00ff00; border-radius: 5px; }

        /* TELA DE LOGIN E BAN */
        .auth-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a0a; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; text-align: center; }
        .auth-card { background: #1a1a1a; padding: 25px; border-radius: 15px; border: 2px solid #00ff00; width: 85%; max-width: 300px; box-shadow: 0 0 20px rgba(0,255,0,0.2); }
        
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #333; background: #222; color: white; outline: none; font-size: 16px; text-align: center; }
        input:focus { border-color: #00ff00; }
        
        button { width: 100%; padding: 12px; background: #00ff00; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #000; transition: 0.2s; }
        button:active { transform: scale(0.95); }

        /* PAINEL DE ADMIN */
        .btn-a { position: absolute; top: 20px; right: 20px; width: 50px; height: 50px; background: red; border-radius: 50%; color: white; display: none; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; z-index: 1500; pointer-events: auto; box-shadow: 0 0 15px red; cursor: pointer; }
        
        #admin-panel { position: absolute; top: 80px; right: 10px; width: 260px; background: rgba(0,0,0,0.95); border: 2px solid #ff0000; border-radius: 12px; padding: 15px; display: none; z-index: 2000; max-height: 70vh; overflow-y: auto; pointer-events: auto; }
        .admin-section { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .player-row { background: #111; padding: 10px; margin-bottom: 5px; border-radius: 5px; border-left: 3px solid #ff0000; display: flex; flex-direction: column; gap: 5px; }
        .player-name { font-size: 12px; font-weight: bold; color: #fff; }
        .btn-action-group { display: flex; gap: 5px; }
        .btn-adm-action { flex: 1; padding: 5px; font-size: 9px; border: none; border-radius: 3px; cursor: pointer; color: white; font-weight: bold; }
        
        /* CHAT E TECLADO */
        #chat-display { position: absolute; top: 10px; left: 10px; width: 250px; height: 150px; pointer-events: none; overflow-y: hidden; display: flex; flex-direction: column; justify-content: flex-end; z-index: 1000; text-shadow: 1px 1px 2px black; }
        .chat-msg { font-size: 12px; margin-bottom: 4px; background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 4px; display: inline-block; max-width: 100%; word-wrap: break-word; }
        
        #chat-toggle { position: absolute; top: 10px; left: 10px; width: 40px; height: 40px; background: rgba(255,255,255,0.2); border: 1px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1500; pointer-events: auto; cursor: pointer; }
        
        #virtual-keyboard { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background: #0f0f0f; z-index: 6000; display: none; flex-direction: column; padding: 5px; box-sizing: border-box; border-top: 2px solid #00ff00; pointer-events: auto; box-shadow: 0 -5px 20px rgba(0,0,0,0.8); }
        .kb-row { display: flex; justify-content: center; gap: 3px; margin-bottom: 3px; flex: 1; }
        .key { flex: 1; background: #333; color: white; border: 1px solid #555; border-radius: 4px; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; max-width: 45px; }
        .key:active { background: #00ff00; color: black; }
        .key-space { flex: 4; max-width: 200px; }
        .key-action { background: #004400; border-color: #00ff00; font-size: 12px; }
        
        #chat-input-preview { width: 100%; padding: 5px; background: #000; color: #00ff00; border: none; text-align: left; font-size: 16px; box-sizing: border-box; border-bottom: 1px solid #333; height: 30px; display: none; }

        /* CONTROLES JOGO */
        #mobile-controls { position: absolute; bottom: 30px; left: 20px; display: grid; grid-template-columns: repeat(3, 70px); grid-gap: 10px; pointer-events: auto; }
        .btn-game { width: 70px; height: 70px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; }
        .btn-jump { position: absolute; bottom: 60px; right: 30px; width: 80px; height: 80px; background: rgba(0,255,0,0.2); border: 2px solid #00ff00; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #00ff00; font-weight: bold; pointer-events: auto; }

        .nametag { position: absolute; background: rgba(0,0,0,0.8); color: #00ff00; padding: 2px 6px; border-radius: 4px; font-size: 10px; transform: translate(-50%, -150%); pointer-events: none; white-space: nowrap; border: 1px solid #00ff00; }
        
        #status-net { position: absolute; top: 10px; right: 10px; color: #00ff00; font-size: 10px; z-index: 100; text-align: right; }
    </style>
</head>
<body>

    <div id="login-screen" class="auth-overlay">
        <div class="auth-card">
            <h2 style="color:#00ff00">NEXUS LOGIN</h2>
            <input type="email" id="email-field" placeholder="Seu Gmail" readonly onclick="openKeyboard(this)">
            <input type="text" id="user-field" placeholder="Nick no Jogo" readonly onclick="openKeyboard(this)">
            <button onclick="request2FA()">RECEBER C√ìDIGO</button>
        </div>
    </div>

    <div id="2fa-screen" class="auth-overlay hidden">
        <div class="auth-card">
            <h2 style="color:#00ff00">VERIFICA√á√ÉO</h2>
            <p style="font-size:12px; color:#aaa;">Olhe seu Gmail</p>
            <input type="text" id="2fa-input" placeholder="000000" readonly onclick="openKeyboard(this)">
            <button onclick="verifyAndStart()">ENTRAR NO MUNDO</button>
            <br><br>
            <button onclick="closeKeyboard()" style="background:#333; color:#aaa; padding:5px; font-size:10px;">FECHAR TECLADO</button>
        </div>
    </div>

    <div id="ban-screen" class="auth-overlay hidden" style="background: #200;">
        <h1 style="color:red; font-size: 40px;">üö´ BANIDO</h1>
        <p id="ban-reason" style="padding: 20px; font-weight: bold; font-size: 18px;"></p>
        <button onclick="location.reload()" style="width: 200px; margin-top:20px;">TENTAR NOVAMENTE</button>
    </div>

    <div id="ui" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;">
        <div id="status-net">Conectando...</div>
        <div id="chat-display"></div>
        <div id="chat-toggle" onclick="openChatMode()">üí¨</div>

        <div id="admin-toggle" class="btn-a" onclick="toggleAdminPanel()">A</div>

        <div id="admin-panel">
            <div class="admin-section">
                <h4 style="color:red; margin:0 0 10px 0;">PODERES SUPREMOS</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                    <button class="btn-adm-action" style="background:#444;" onclick="changeSize(3.5)">GIGANTE</button>
                    <button class="btn-adm-action" style="background:#444;" onclick="changeSize(0.4)">PEQUENA</button>
                    <button class="btn-adm-action" style="background:#444;" onclick="toggleFly()" id="fly-status">VOAR: OFF</button>
                    <button class="btn-adm-action" style="background:#444;" onclick="toggleSpeed()" id="speed-status">VEL: 1X</button>
                </div>
            </div>
            
            <div class="admin-section">
                <h4 style="color:red; margin:0 0 10px 0;">GERENCIAMENTO</h4>
                <div style="background:#222; padding:5px; border-radius:5px; margin-bottom:10px;">
                    <label style="font-size:10px; color:#aaa;">Tempo Ban (min):</label>
                    <input type="number" id="ban-time-input" value="5" style="width:90%; padding:5px; font-size:12px; pointer-events:auto;" onclick="openKeyboard(this)">
                </div>
                
                <div id="player-list-container">
                    <p style="font-size:10px; color:#aaa; text-align:center;">Nenhum player conectado.</p>
                </div>
            </div>
            
            <button onclick="toggleAdminPanel()" style="width:100%; background:#222; color:white; border:none; padding:10px; border-radius:5px; margin-top:10px;">FECHAR</button>
        </div>

        <div id="mobile-controls">
            <div style="grid-column: 2" class="btn-game" onpointerdown="keys.w=true" onpointerup="keys.w=false">W</div>
            <div style="grid-column: 1" class="btn-game" onpointerdown="keys.a=true" onpointerup="keys.a=false">A</div>
            <div style="grid-column: 2" class="btn-game" onpointerdown="keys.s=true" onpointerup="keys.s=false">S</div>
            <div style="grid-column: 3" class="btn-game" onpointerdown="keys.d=true" onpointerup="keys.d=false">D</div>
        </div>
        <div class="btn-jump" onpointerdown="jump()">PULO</div>
    </div>

    <div id="virtual-keyboard">
        <div id="chat-input-preview"></div> <div style="flex:1; display:flex; flex-direction:column; padding-top:5px;" id="kb-keys"></div>
    </div>

    <div id="tag-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

    <script>
        // --- CONFIG ---
        const PUBLIC_KEY = "moDwTMHMA3q3OPbuy"; 
        const SERVICE_ID = "default_service";   
        const TEMPLATE_ID = "template_axhickg"; 
        
        // ID FIXO PARA O "HOST" DA SALA
        const SERVER_ID = "nexus-engine-global-host-v2";

        (function(){ emailjs.init(PUBLIC_KEY); })();

        // --- VARI√ÅVEIS GLOBAIS ---
        let myCode = "", myEmail = "", myNick = "", isAdmin = false;
        let isFlying = false, currentSpeed = 0.2, velocityY = 0, isGrounded = true;
        let chatBuffer = "";
        let activeInput = null;
        
        const keys = { w: false, a: false, s: false, d: false };
        let playerMesh, peer;
        let remotePlayers = {}; 
        
        // Multiplayer Logic Vars
        let isHost = false;
        let hostConn = null; // Se eu sou cliente, aqui fica a conex√£o com o host

        // --- SISTEMA DE TECLADO VIRTUAL ---
        function initKeyboard() {
            const rows = ["1234567890", "QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM@._-"];
            const container = document.getElementById('kb-keys');
            
            rows.forEach(rowString => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'kb-row';
                const chars = rowString.includes("@") ? ["Z","X","C","V","B","N","M","@","."] : rowString.split('');
                const listToRender = rowString.includes("12") ? rowString.split('') : chars;

                listToRender.forEach(char => {
                    const k = document.createElement('div');
                    k.className = 'key';
                    k.innerText = char;
                    k.onclick = () => typeChar(char);
                    rowDiv.appendChild(k);
                });
                container.appendChild(rowDiv);
            });

            const lastRow = document.createElement('div');
            lastRow.className = 'kb-row';
            const backBtn = document.createElement('div'); backBtn.className = 'key key-action'; backBtn.innerText = "‚å´"; backBtn.style.background = "#500"; backBtn.onclick = handleBackspace;
            const spaceBtn = document.createElement('div'); spaceBtn.className = 'key key-space'; spaceBtn.innerText = "ESPA√áO"; spaceBtn.onclick = () => typeChar(" ");
            const sendBtn = document.createElement('div'); sendBtn.className = 'key key-action'; sendBtn.innerText = "OK / ENVIAR"; sendBtn.style.background = "#050"; sendBtn.onclick = handleEnter;
            lastRow.appendChild(backBtn); lastRow.appendChild(spaceBtn); lastRow.appendChild(sendBtn);
            container.appendChild(lastRow);
        }

        function openKeyboard(inputElement) {
            activeInput = inputElement; 
            document.getElementById('virtual-keyboard').style.display = 'flex';
            document.getElementById('chat-input-preview').style.display = 'none';
            document.getElementById('mobile-controls').style.display = 'none';
        }

        function closeKeyboard() {
            document.getElementById('virtual-keyboard').style.display = 'none';
            activeInput = null;
            if(playerMesh) document.getElementById('mobile-controls').style.display = 'grid';
        }

        function openChatMode() {
            if(document.getElementById('virtual-keyboard').style.display === 'flex') {
                closeKeyboard();
            } else {
                activeInput = null; chatBuffer = ""; updatePreview();
                document.getElementById('virtual-keyboard').style.display = 'flex';
                document.getElementById('chat-input-preview').style.display = 'block';
                document.getElementById('mobile-controls').style.display = 'none';
            }
        }

        function typeChar(c) {
            if (activeInput) activeInput.value += c;
            else if(chatBuffer.length < 35) { chatBuffer += c; updatePreview(); }
        }

        function handleBackspace() {
            if (activeInput) activeInput.value = activeInput.value.slice(0, -1);
            else { chatBuffer = chatBuffer.slice(0, -1); updatePreview(); }
        }

        function handleEnter() {
            if (activeInput) closeKeyboard();
            else sendChat();
        }

        function updatePreview() { document.getElementById('chat-input-preview').innerText = chatBuffer + "|"; }

        function sendChat() {
            if(!chatBuffer.trim()) return;
            const msgObj = { type: 'chat', nick: myNick, text: chatBuffer, color: isAdmin ? '#ff0000' : '#00ff00' };
            // Adiciona localmente e envia
            addChatMessage(msgObj.nick, msgObj.text, msgObj.color);
            broadcast(msgObj); 
            closeKeyboard();
        }

        function addChatMessage(nick, text, color) {
            const d = document.getElementById('chat-display');
            const m = document.createElement('div');
            m.className = 'chat-msg';
            m.innerHTML = `<span style="color:${color}; font-weight:bold;">${nick}:</span> ${text}`;
            d.appendChild(m);
            if(d.children.length > 6) d.removeChild(d.children[0]);
        }

        // --- SISTEMA DE LOGIN & BAN ---
        function checkBans() {
            if(localStorage.getItem('nexus_ban_perm')) { showBanScreen("BANIDO PERMANENTEMENTE."); return true; }
            const banTime = localStorage.getItem('nexus_ban_until');
            if(banTime && Date.now() < parseInt(banTime)) {
                const rest = Math.ceil((parseInt(banTime) - Date.now()) / 60000);
                showBanScreen(`BANIDO TEMPORARIAMENTE. VOLTE EM ${rest} MIN.`);
                return true;
            }
            return false;
        }

        function showBanScreen(msg) {
            document.getElementById('ban-screen').classList.remove('hidden');
            document.getElementById('ban-reason').innerText = msg;
            document.getElementById('login-screen').classList.add('hidden');
        }

        function request2FA() {
            myEmail = document.getElementById('email-field').value.trim().toLowerCase();
            myNick = document.getElementById('user-field').value.trim();
            if(!myEmail.includes("@") || myNick.length < 2) return alert("Dados inv√°lidos!");

            const btn = document.querySelector('#login-screen button');
            btn.innerText = "ENVIANDO..."; btn.disabled = true;

            myCode = Math.floor(100000 + Math.random() * 900000).toString();
            emailjs.send(SERVICE_ID, TEMPLATE_ID, { to_email: myEmail, code: myCode, user_nick: myNick })
                .then(() => {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('2fa-screen').classList.remove('hidden');
                    closeKeyboard();
                }).catch(err => {
                    btn.innerText = "ERRO (Tente de novo)"; btn.disabled = false;
                    console.error(err);
                    alert("Erro de conex√£o com EmailJS.");
                });
        }

        function verifyAndStart() {
            if(document.getElementById('2fa-input').value === myCode) {
                if(myEmail === "luanaaalmeidadesouza@gmail.com") {
                    isAdmin = true;
                    myNick = "üëë " + myNick;
                    document.getElementById('admin-toggle').style.display = 'flex';
                }
                document.getElementById('2fa-screen').classList.add('hidden');
                closeKeyboard();
                startEngine();
            } else { alert("C√≥digo errado!"); }
        }

        // --- ENGINE 3D ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });

        function startEngine() {
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            scene.background = new THREE.Color(isAdmin ? 0x110505 : 0x050505);

            const grid = new THREE.GridHelper(100, 50, 0x00ff00, 0x222222);
            scene.add(grid);
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));

            playerMesh = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshPhongMaterial({ color: isAdmin ? 0xff0000 : 0x00ff00 }));
            playerMesh.position.y = 0.5;
            scene.add(playerMesh);

            initNetwork(); // AQUI EST√Å A M√ÅGICA
            initKeyboard();
            animate();
            
            document.getElementById('mobile-controls').style.display = 'grid';
            document.querySelector('.btn-jump').style.display = 'flex';
        }

        // --- REDE (MULTIPLAYER CORRIGIDO COM STAR TOPOLOGY) ---
        function initNetwork() {
            // Tenta se conectar como HOST primeiro (tenta pegar o ID do servidor)
            attemptToHost();
        }

        function attemptToHost() {
            document.getElementById('status-net').innerText = "Tentando criar sala...";
            // Tenta abrir conex√£o com o ID FIXO
            peer = new Peer(SERVER_ID);

            peer.on('open', id => {
                isHost = true;
                document.getElementById('status-net').innerText = "VOC√ä √â O HOST";
                console.log("Servidor iniciado: " + id);
            });

            peer.on('connection', conn => {
                handleConnection(conn);
            });

            peer.on('error', err => {
                if(err.type === 'unavailable-id') {
                    // O ID j√° existe, ent√£o j√° tem um Host. Vou virar Cliente.
                    connectAsClient();
                } else {
                    console.log(err);
                }
            });
        }

        function connectAsClient() {
            isHost = false;
            document.getElementById('status-net').innerText = "Entrando na sala...";
            peer = new Peer(); // ID Aleat√≥rio

            peer.on('open', id => {
                console.log("Meu ID Cliente: " + id);
                // Conecta ao Host Fixo
                hostConn = peer.connect(SERVER_ID);
                
                hostConn.on('open', () => {
                    document.getElementById('status-net').innerText = "CONECTADO AO MUNDO";
                    // Manda oi
                    hostConn.send({ type: 'hello', nick: myNick });
                });

                handleConnection(hostConn);
            });
            
            // Se eu recebo conex√µes sendo cliente (estranho, mas ok), ignoro ou trato
            peer.on('connection', conn => { conn.close(); });
        }

        function handleConnection(conn) {
            conn.on('data', data => {
                
                // L√ìGICA DO HOST (RELAY)
                if(isHost) {
                    // Se sou Host, preciso atualizar meu mundo E avisar os outros
                    // O pacote 'data' vem de um cliente.
                    // Adicionamos o ID original para retransmitir
                    const senderId = conn.peer;
                    
                    // Processa localmente no Host
                    processData(senderId, data);

                    // Repassa para TODOS os outros clientes (menos quem mandou)
                    // Pacote de Relay
                    const relayData = { ...data, originId: senderId };
                    
                    for(let id in remotePlayers) {
                        const p = remotePlayers[id];
                        if(p.conn && p.conn.peer !== senderId && p.conn.open) {
                            p.conn.send(relayData);
                        }
                    }
                } 
                // L√ìGICA DO CLIENTE
                else {
                    // Se sou cliente, recebo dados do Host.
                    // O Host manda dados dele, OU dados 'relay' de outros players.
                    const origin = data.originId || SERVER_ID; // Se n√£o tem originId, veio do Host mesmo
                    processData(origin, data);
                }
            });

            conn.on('close', () => {
                if(isHost) {
                    removePlayer(conn.peer);
                    // Avisa outros que algu√©m saiu? (Opcional, mas bom)
                } else {
                    // Se o host fechou
                    document.getElementById('status-net').innerText = "DESCONECTADO (Host saiu)";
                    removeAllPlayers();
                }
            });
        }

        function processData(id, data) {
            if(data.type === 'move') {
                if(!remotePlayers[id]) createRemotePlayer(id, data.nick);
                updateRemotePlayer(id, data);
            }
            if(data.type === 'chat') {
                // Se eu j√° tenho a msg (fui eu que mandei e voltou pelo relay), ignoro?
                // O addChatMessage j√° filtra duplicatas visuais simples, mas aqui vamos assumir que recebemos.
                // Mas cuidado: se eu mando msg, eu ja mostrei na minha tela.
                if(data.nick !== myNick) addChatMessage(data.nick, data.text, data.color);
            }
            if(data.type === 'ban_command') {
                // Se recebi comando de ban, verifico se sou o alvo
                // No Relay, o ID do alvo vem dentro do data, n√£o √© o connection peer
                // Mas aqui √© simplificado. O comando de ban vem "broadcastado".
                // Se o comando diz "banir X", e eu sou X, eu me bano.
                // Mas o sistema original mandava direto pro alvo.
                // Vamos manter simples: S√≥ funciona se a conex√£o for direta? 
                // N√£o, via relay temos que ver se o ID bate.
                // Na vers√£o simplificada, o Admin manda direto pro Host, o Host bane.
            }
            // Admin logic specific:
            if(data.type === 'admin_direct_ban') {
                if(data.targetId === peer.id) {
                    if(data.mode === 'perm') { localStorage.setItem('nexus_ban_perm', 'true'); location.reload(); }
                    if(data.mode === 'temp') { localStorage.setItem('nexus_ban_until', (Date.now() + data.minutes * 60000).toString()); location.reload(); }
                }
            }
            if(data.type === 'admin_tp') {
                 // Teleport logic
            }
        }

        // Fun√ß√£o principal de envio
        function broadcast(data) {
            if(isHost) {
                // Sou Host: Envio meus dados para TODOS os clientes conectados
                for(let id in remotePlayers) {
                    const p = remotePlayers[id];
                    if(p.conn && p.conn.open) p.conn.send(data);
                }
            } else {
                // Sou Cliente: Envio APENAS para o Host
                if(hostConn && hostConn.open) {
                    hostConn.send(data);
                }
            }
        }

        // --- MANIPULA√á√ÉO DE PLAYERS REMOTOS ---
        function createRemotePlayer(id, nick) {
            if(remotePlayers[id]) return; // J√° existe
            const m = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshPhongMaterial({color: 0x00ff00}));
            scene.add(m);
            const t = document.createElement('div');
            t.className = 'nametag';
            document.getElementById('tag-container').appendChild(t);
            // Se sou Host, preciso guardar a conex√£o. Se sou cliente, n√£o tenho a conex√£o direta com esse player (tenho com o host)
            // Mas o processData chama isso.
            // Truque: Se sou Host, a conex√£o veio do handleConnection. Onde guardo?
            // O handleConnection do Host precisa registrar o player no remotePlayers.
            // Pequeno ajuste: O 'createRemotePlayer' no Host deve ser chamado assim que a conex√£o abre ou no primeiro Hello.
            
            // Ajuste na l√≥gica para funcionar com 'remotePlayers' sendo usado tanto para render quanto para rede no Host:
            // No Host, `remotePlayers[id].conn` deve existir.
            // No Cliente, `remotePlayers[id].conn` √© null ou irrelevante, pois tudo vai pro Host.
            
            remotePlayers[id] = { mesh: m, tag: t, nick: nick || "Player", conn: null };
            
            if(isAdmin) updateAdminList();
        }
        
        // Host-specific: Registrar conex√£o
        // Reescrevendo connection para salvar no remotePlayers
        const _origHandle = handleConnection;
        handleConnection = function(conn) {
            _origHandle(conn);
            if(isHost) {
                // Quando um cliente conecta, criamos um slot tempor√°rio
                conn.on('open', () => {
                    // Espera primeiro pacote para nomear, mas guarda a ref
                    // Se n√£o tivermos o player ainda, criamos um placeholder
                    if(!remotePlayers[conn.peer]) {
                         createRemotePlayer(conn.peer, "Conectando...");
                    }
                    remotePlayers[conn.peer].conn = conn;
                });
            }
        }

        function updateRemotePlayer(id, data) {
            const p = remotePlayers[id];
            if(!p) return;
            p.mesh.position.set(data.x, data.y, data.z);
            p.mesh.scale.set(data.s, data.s, data.s);
            p.tag.innerText = data.nick;
            p.nick = data.nick; // Update nick
            p.tag.style.color = data.isAdmin ? 'red' : '#00ff00';
            p.mesh.material.color.setHex(data.isAdmin ? 0xff0000 : 0x00ff00);
        }

        function removePlayer(id) {
            if(remotePlayers[id]) {
                scene.remove(remotePlayers[id].mesh);
                remotePlayers[id].tag.remove();
                delete remotePlayers[id];
                if(isAdmin) updateAdminList();
            }
        }
        
        function removeAllPlayers() {
            for(let id in remotePlayers) removePlayer(id);
        }

        // --- L√ìGICA DE ADMIN ---
        function updateAdminList() {
            const list = document.getElementById('player-list-container');
            list.innerHTML = "";
            const ids = Object.keys(remotePlayers);
            if(ids.length === 0) {
                list.innerHTML = "<p style='color:#555; font-size:10px; text-align:center;'>Ningu√©m por perto...</p>";
                return;
            }
            ids.forEach(id => {
                const p = remotePlayers[id];
                const row = document.createElement('div');
                row.className = 'player-row';
                row.innerHTML = `
                    <span class="player-name">${p.nick}</span>
                    <div class="btn-action-group">
                        <button class="btn-adm-action" style="background:#f90;" onclick="adminBan('${id}', 'temp')">TEMP</button>
                        <button class="btn-adm-action" style="background:#f00;" onclick="adminBan('${id}', 'perm')">PERM</button>
                        <button class="btn-adm-action" style="background:#00f;" onclick="adminTpTo('${id}')">TP</button>
                    </div>
                `;
                list.appendChild(row);
            });
        }

        function adminBan(targetId, type) {
            const min = document.getElementById('ban-time-input').value;
            // Envia comando especial
            const cmd = { type: 'admin_direct_ban', targetId: targetId, mode: type, minutes: min };
            broadcast(cmd);
            // Se sou host, removo localmente, mas o broadcast j√° deve avisar
            alert(`Comando ban enviado para ${targetId}`);
        }

        function adminTpTo(id) {
            const p = remotePlayers[id];
            if(p) { playerMesh.position.copy(p.mesh.position); playerMesh.position.y += 2; }
        }

        // --- GAME LOOP ---
        function toggleAdminPanel() { 
            const p = document.getElementById('admin-panel'); 
            p.style.display = p.style.display === 'block' ? 'none' : 'block'; 
            if(p.style.display === 'block') updateAdminList();
        }
        function changeSize(s) { playerMesh.scale.set(s,s,s); }
        function toggleFly() { isFlying = !isFlying; document.getElementById('fly-status').innerText = isFlying ? "VOAR: ON" : "VOAR: OFF"; }
        function toggleSpeed() { currentSpeed = currentSpeed > 0.3 ? 0.2 : 0.8; document.getElementById('speed-status').innerText = currentSpeed > 0.3 ? "VEL: MAX" : "VEL: 1X"; }
        function jump() { if(isFlying) playerMesh.position.y += 1.5; else if(isGrounded) { velocityY = 0.28; isGrounded = false; } }

        function animate() {
            requestAnimationFrame(animate);
            if(playerMesh) {
                if(keys.w) playerMesh.position.z -= currentSpeed;
                if(keys.s) playerMesh.position.z += currentSpeed;
                if(keys.a) playerMesh.position.x -= currentSpeed;
                if(keys.d) playerMesh.position.x += currentSpeed;

                if(!isFlying) {
                    playerMesh.position.y += velocityY;
                    const floor = playerMesh.scale.y / 2;
                    if(playerMesh.position.y > floor) velocityY -= 0.015;
                    else { playerMesh.position.y = floor; velocityY = 0; isGrounded = true; }
                }

                camera.position.lerp(new THREE.Vector3(playerMesh.position.x, 7 + (playerMesh.scale.y * 2), playerMesh.position.z + 12), 0.1);
                camera.lookAt(playerMesh.position);

                // Envia dados constantemente
                broadcast({ 
                    type: 'move', x: playerMesh.position.x, y: playerMesh.position.y, z: playerMesh.position.z,
                    s: playerMesh.scale.x, nick: myNick, isAdmin: isAdmin
                });

                // Renderiza Tags
                for(let id in remotePlayers) {
                    const p = remotePlayers[id];
                    const v = p.mesh.position.clone().add(new THREE.Vector3(0, p.mesh.scale.y + 0.5, 0)).project(camera);
                    // Checa se est√° na frente da camera
                    if(v.z < 1) {
                        const x = (v.x * .5 + .5) * window.innerWidth;
                        const y = (v.y * -.5 + .5) * window.innerHeight;
                        p.tag.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
                        p.tag.style.display = 'block';
                    } else { p.tag.style.display = 'none'; }
                }
            }
            renderer.render(scene, camera);
        }

        if(!checkBans()) {
            console.log("Nexus Engine Pronta.");
            initKeyboard();
        }
    </script>
</body>
</html>
